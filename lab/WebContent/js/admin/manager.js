var timeoutID=null;var islogin=true;var introduceMessageLoaded=false;var adminLogNoticeLoaded=false;var pageSize=20;var currentStore=null;var af_refresh=null;var pr_refresh=null;var emptySearchText="输入关键词";function showMsg(A){if(!A){return }$("msg_content").innerHTML=A+" <a href=# onclick='clearMsg();return false;'><img src='resources/images/close.gif'/></a>";$("msg").style.display="block";if(timeoutID!=null){clearTimeout(timeoutID)}timeoutID=setTimeout("clearMsg()",30000)}function clearMsg(){$("msg").style.display="none";$("msg_content").innerHTML=""}var equipPanel=new Ext.TabPanel({activeTab:0,width:482,height:200,cls:"comp-left2",items:[{id:"equip_tab_0",title:"设备图片",xtype:"panel",html:'<div style="float:left;"><img id="equip_image" src="resources/images/indicator.gif"/></div><div style="padding:10px;" id="equip_tip">&nbsp;提示：<br/>&nbsp;图片正在加载中...</div>'},new Ext.form.TextArea({id:"equip_tab_1",title:"性能参数",name:"specification",readOnly:true,width:378,maxLength:150}),new Ext.form.TextArea({id:"equip_tab_2",title:"操作规程",readOnly:true,name:"caution",width:378,maxLength:1000}),new Ext.form.TextArea({id:"equip_tab_3",readOnly:true,title:"收费方式",name:"remark",width:378,maxLength:1000})]});var tabPanel=new Ext.TabPanel({id:"tabPanel",region:"center",enableTabScroll:true,deferredRender:false,activeTab:0,items:[{contentEl:"center",title:"欢迎使用",autoScroll:true,iconCls:"home"}]});tabPanel.addListener("beforeremove",function(B,A){if(A.getId()=="pr_equipManager"){clearInterval(pr_refresh);pr_refresh=null}else{if(A.getId()=="af_equipManager"){clearInterval(af_refresh);af_refresh=null}}});var deleteWin=null;function deleteFileFromServer(){if(!isAdmin){alertOnlyAdminDo();return }if(!deleteWin){var A=new Ext.form.FormPanel({labelWidth:100,labelAlign:"right",frame:true,items:[new Ext.form.ComboBox({fieldLabel:"资源类别",hiddenName:"type",store:["File","Image","Flash","Media"],width:125,typeAhead:true,allowBlank:false,mode:"local",triggerAction:"all",selectOnFocus:true,value:"File",editable:false}),new Ext.form.TextField({fieldLabel:"要删除的文件(夹)",name:"file",width:190,allowBlank:false}),{html:'<font color=green>请确保要删除的文件(夹)的路径正确,可<a href="#" onclick="openBrowseServerWin();return false;">浏览服务器文件</a>确认路径后再填写,如： /download/test.doc 或 test2.jpg</font><br/><font color=red>只有组别为的管理员的用户能进行文件删除操作。</font>'}],buttons:[{text:"删除",handler:function(){if(A.form.isValid()){Ext.MessageBox.confirm("确认从服务器删除文件(夹)","是否确认删除 /"+A.getForm().findField("type").getValue()+"/"+A.getForm().findField("file").getValue()+" ?",function(B){if("yes"!=B){return }DWRUtil.useLoadingMessage("处理中...");Notice.deleteFile(A.getForm().findField("type").getValue(),A.getForm().findField("file").getValue(),{callback:function(D){cancelLoadingMessage();var C=Ext.decode(D);if(C.result){deleteWin.hide();showMsg(C.message);if(browseServerWin&&!browseServerWin.closed){browseServerWin.location.reload()}}else{Ext.Msg.alert("报告",C.message)}},errorHandler:function(C){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})})}}},{text:"重置",handler:function(){A.form.reset()}},{text:"取消",handler:function(){deleteWin.hide()}}]});deleteWin=new Ext.Window({el:"file-delete-win",title:"从服务器上删除文件(夹)",modal:true,layout:"fit",closeAction:"hide",width:350,height:180,resizable:false,items:[A]})}deleteWin.show()}Ext.onReady(function(){DWREngine.setTimeout(30000);Ext.BLANK_IMAGE_URL="resources/images/default/s.gif";Ext.QuickTips.init();Ext.form.Field.prototype.msgTarget="qtip";var E=new Ext.state.CookieProvider();var F=E.get("cookie_theme");if(F==null||F==""){F="resources/css/ext-all.css"}Ext.util.CSS.swapStyleSheet("theme",F);Ext.state.Manager.setProvider(E);var D=new Ext.form.ComboBox({store:new Ext.data.SimpleStore({fields:["display","value"],data:themeArray}),renderTo:"theme-selector",displayField:"display",typeAhead:true,mode:"local",triggerAction:"all",selectOnFocus:true,editable:false,resizable:false,listWidth:100,width:100,valueField:"value",value:F});D.on("select",function(G){Ext.util.CSS.swapStyleSheet("theme",G.getValue());E.set("cookie_theme",G.getValue())},this);$("loading_div").parentNode.removeChild($("loading_div"));Ext.getDom("theme-selector").style.visibility="visible";$("account_div").style.visibility="visible";var A=new Ext.Viewport({layout:"border",items:[new Ext.BoxComponent({region:"north",el:"north-div",height:82}),{region:"west",id:"west-panel",title:"菜单栏",split:true,width:200,minSize:175,maxSize:400,collapsible:true,margins:"0 0 5 5",cmargins:"0 5 5 5",layout:"accordion",layoutConfig:{animate:true},items:[{title:"设备预约管理",html:Ext.getDom("equipMenus").innerHTML,border:false,autoScroll:true,iconCls:"equip"},{title:"预约审批日志",html:Ext.getDom("logMenus").innerHTML,border:false,autoScroll:true,iconCls:"unit"},{title:"用户管理",html:Ext.getDom("userMenus").innerHTML,autoScroll:true,border:false,iconCls:"user"},{title:"公告反馈管理",html:Ext.getDom("noticeMenus").innerHTML,autoScroll:true,border:false,iconCls:"notice"}]},tabPanel]});var C=(window.innerWidth)?window.innerWidth:(document.documentElement&&document.documentElement.clientWidth)?document.documentElement.clientWidth:document.body.offsetWidth;if(C-265<800){C=1050}var B=new Ext.Panel({id:"main-panel",baseCls:"x-plain",renderTo:Ext.get("center"),layout:"table",layoutConfig:{columns:2},defaults:{frame:true,width:C-265,height:365},items:[{title:"使用说明",colspan:2,height:480,collapsible:true,collapsed:true,contentEl:"introduceDiv",listeners:{beforeexpand:{fn:function(){if(introduceMessageLoaded){return }DWRUtil.useLoadingMessage("加载中...");Message.getIntroduceMessagesByType(1,{callback:function(G){cancelLoadingMessage();$("introduceDiv").innerHTML=G;introduceMessageLoaded=true},errorHandler:function(G){cancelLoadingMessage();showMsg("对不起，加载使用说明失败!");$("introduceDiv").innerHTML="对不起，加载使用说明失败!"}})},scope:this}}},{title:"预约信息",colspan:2,collapsible:true,contentEl:"messageDiv0"},{title:"审批信息",colspan:2,collapsible:true,collapsed:true,contentEl:"messageDiv1",listeners:{beforeexpand:{fn:function(){if(adminLogNoticeLoaded){return }initAdminLogNotice();adminLogNoticeLoaded=true},scope:this}}}]});Ext.getDom("menus").innerHTML="";checkUndoTasks();initUserLogNotice()});function checkUndoTasks(){Notice.getUndoTasks({callback:function(A){if(A!=null&&A!=""){$("msg_content").innerHTML="<img style='width:14px;height:14px;' src='resources/icons/info.png' alt='To Do'/>&nbsp;"+A;$("msg").style.display="block"}},errorHandler:function(A){}})}function onClickMenuItem(A){updateTab(A.id,A.innerHTML)}function addTab(B,A){switch(B){case"pr_equipManager":initPrEquipManager(B,A);break;case"af_equipManager":initAfEquipManager(B,A);break;case"equipManager":initEquipManager(B,A);break;case"all_equipManager":initAllEquipManager(B,A);break;case"userManager":if(!isAdmin){alertOnlyAdminDo()}else{initUserManager(B,A)}break;case"adminManager":if(!isAdmin){alertOnlyAdminDo()}else{initAdminManager(B,A)}break;case"userSearch":if(!isAdmin){alertOnlyAdminDo()}else{initUserSearch(B,A)}break;case"user_logManager":initUserLogManager(B,A);break;case"admin_logManager":initAdminLogManager(B,A);break;case"noticeManager":if(!isAdmin){alertOnlyAdminDo()}else{initNoticeManager(B,A)}break;case"feedbackManager":if(!isAdmin){alertOnlyAdminDo()}else{initFeedbackManager(B,A)}break;case"browseServer":if(!isAdmin){alertOnlyAdminDo()}else{initBrowseServer(B,A)}break;default:showMsg("此功能需要实现！")}}function addQueueTab(A,B){initQueueEquipManager(A,B)}function updateTab(C,B){var A=tabPanel.getItem(C);if(A){tabPanel.remove(A)}A=addTab(C,B);tabPanel.setActiveTab(A)}var editWin;Ext.getDom("equip-edit-win").innerHTML="";var equiptip=null;function showEquipEditWin(B){if(!editWin){var A=new Ext.FormPanel({labelWidth:100,frame:true,labelAlign:"right",buttonAlign:"left",defaultType:"textfield",items:[new Ext.form.Hidden({name:"id"}),new Ext.form.TextField({fieldLabel:"设备名称*",name:"name",width:378,readOnly:true,maxLength:50,allowBlank:false}),new Ext.form.TextField({fieldLabel:"编号*",name:"no",readOnly:true,width:132,maxLength:50,itemCls:"comp-left0",clearCls:"allow-float",allowBlank:false}),new Ext.form.TextField({fieldLabel:"型号*",name:"model",width:132,readOnly:true,maxLength:50,itemCls:"comp-left",clearCls:"stop-float",allowBlank:false}),new Ext.form.TextField({fieldLabel:"单价",name:"price",readOnly:true,itemCls:"comp-left0",clearCls:"allow-float",width:132,maxLength:50}),new Ext.form.TextField({fieldLabel:"存放位置",name:"location",readOnly:true,itemCls:"comp-left",clearCls:"stop-float",width:132,maxLength:50}),new Ext.form.TextField({fieldLabel:"国别",name:"country",readOnly:true,width:132,maxLength:50,itemCls:"comp-left0",clearCls:"allow-float"}),new Ext.form.TextField({fieldLabel:"生产厂商",name:"company",readOnly:true,itemCls:"comp-left",clearCls:"stop-float",width:132,maxLength:50}),{xtype:"textfield",fieldLabel:"出厂日期",name:"year1",readOnly:true,itemCls:"comp-left0",clearCls:"allow-float",width:132,format:"Y-m-d"},{xtype:"textfield",fieldLabel:"购置日期",name:"year2",readOnly:true,itemCls:"comp-left",clearCls:"stop-float",width:132,format:"Y-m-d"},new Ext.form.ComboBox({fieldLabel:"设备类别*",hiddenName:"type",store:new Ext.data.SimpleStore({fields:["returnValue","displayValue"],data:equipArray2}),valueField:"returnValue",displayField:"displayValue",typeAhead:true,allowBlank:false,itemCls:"comp-left0",clearCls:"allow-float",width:132,mode:"local",emptyText:"选择设备类别...",selectOnFocus:true,editable:false}),new Ext.form.TextField({fieldLabel:"负责人",name:"admin",readOnly:true,width:132,itemCls:"comp-left",clearCls:"stop-float",maxLength:50}),new Ext.form.TextField({fieldLabel:"联系方式",name:"mobile",readOnly:true,width:378,itemCls:"comp-left0",clearCls:"stop-float",maxLength:150}),equipPanel,new Ext.form.NumberField({fieldLabel:"处理时间(分/样)*",name:"sampletime",width:132,minValue:1,allowDecimals:false,maxLength:8,itemCls:"comp-left0",clearCls:"allow-float",allowBlank:false}),new Ext.form.NumberField({fieldLabel:"费用(元/分)*",name:"fee",width:132,decimalPrecision:2,minValue:0,maxLength:8,itemCls:"comp-left",clearCls:"stop-float",allowBlank:false}),{xtype:"checkbox",fieldLabel:"是否公用",boxLabel:"允许公用",itemCls:"comp-left0",clearCls:"allow-float",disabled:true,checked:false,name:"pub"},{xtype:"checkbox",fieldLabel:"是否收费",boxLabel:"收费",itemCls:"comp-left1",clearCls:"stop-float",checked:false,name:"charge"},{xtype:"checkbox",fieldLabel:"使用状态",boxLabel:"允许预约",itemCls:"comp-left0",clearCls:"allow-float",checked:false,name:"status"},{xtype:"checkbox",fieldLabel:"预约冲突",boxLabel:"检查",itemCls:"comp-left1",clearCls:"stop-float",checked:true,name:"checkd"},{xtype:"checkbox",fieldLabel:"允许预约日期",boxLabel:"周一",itemCls:"comp-left0",clearCls:"allow-float",checked:true,name:"appd1"},{xtype:"checkbox",boxLabel:"周二",hideLabel:true,itemCls:"comp-left2",clearCls:"allow-float",checked:true,name:"appd2"},{xtype:"checkbox",boxLabel:"周三",hideLabel:true,itemCls:"comp-left2",clearCls:"allow-float",checked:true,name:"appd3"},{xtype:"checkbox",boxLabel:"周四",hideLabel:true,itemCls:"comp-left2",clearCls:"allow-float",checked:true,name:"appd4"},{xtype:"checkbox",boxLabel:"周五",hideLabel:true,itemCls:"comp-left2",clearCls:"stop-float",checked:true,name:"appd5"},{xtype:"checkbox",boxLabel:"周六",hideLabel:true,itemCls:"comp-left2",clearCls:"allow-float",checked:false,width:150,name:"appd6"},{xtype:"checkbox",boxLabel:"周日",hideLabel:true,itemCls:"comp-left2",clearCls:"stop-float",checked:false,width:150,name:"appd0"},{xtype:"timefield",fieldLabel:"预约起始时间*",name:"appt1",allowBlank:false,itemCls:"comp-left0",clearCls:"allow-float",increment:30,width:132,format:"H:i"},{xtype:"timefield",fieldLabel:"预约结束时间*",name:"appt2",allowBlank:false,itemCls:"comp-left",clearCls:"stop-float",increment:30,width:132,format:"H:i"}]});editWin=new Ext.Window({el:"equip-edit-win",title:"修改设备状态",modal:true,layout:"fit",closeAction:"hide",width:520,height:620,resizable:false,items:[A],buttons:[{text:"保存",handler:function(){if(A.getForm().findField("appt1").getValue()>=A.getForm().findField("appt2").getValue()){A.getForm().findField("appt2").markInvalid("预约最晚时间应比最早时间晚！")}else{if(A.form.isValid()){var E=new Object();E.id=A.getForm().findField("id").getValue();E.status=A.getForm().findField("status").getValue();var C=new Array();for(var D=0;D<7;D++){if(A.getForm().findField("appd"+D).getValue()==false){C.push(D)}}E.appd=C;E.appt1=A.getForm().findField("appt1").getValue();E.appt2=A.getForm().findField("appt2").getValue();E.sampletime=A.getForm().findField("sampletime").getValue();E.fee=A.getForm().findField("fee").getValue();E.checkd=A.getForm().findField("checkd").getValue();E.charge=A.getForm().findField("charge").getValue();editWin.hide();DWRUtil.useLoadingMessage("处理中...");Equip.updateEquipStatus(Ext.encode(E),{callback:function(G){cancelLoadingMessage();var F=Ext.decode(G);if(F.result){A.form.reset();showMsg(F.message);if(currentStore!=null){currentStore.reload()}}else{Ext.Msg.alert("报告",F.message)}},errorHandler:function(F){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})}}}},{text:"取消",handler:function(){editWin.hide()}}]})}DWRUtil.useLoadingMessage("处理中...");Equip.getEquipDetailInfoById(B,{callback:function(H){cancelLoadingMessage();if(!H){Ext.Msg.alert("错误","对不起，程序出现错误!");return }var F=Ext.data.Record.create([{name:"id",mapping:"id"}]);var D=Ext.decode(H);var G=new F(D);var C=G.data.appd;var I=[true,true,true,true,true,true,true];for(var E=0;E<C.length;E++){I[C[E]]=false}for(var E=0;E<I.length;E++){G.data["appd"+E]=I[E]}editWin.show();for(var E=0;E<4;E++){equipPanel.setActiveTab("equip_tab_"+E)}document.getElementById("equip_image").style.width=227+"px";document.getElementById("equip_image").style.height=170+"px";if(G.data.image==""){document.getElementById("equip_image").src="resources/images/unuploaded.jpg";document.getElementById("equip_tip").innerHTML="&nbsp;提示：<br/>&nbsp;<li>该设备暂时未添加图片</li><br/>"}else{document.getElementById("equip_image").src="resources/equip/"+G.data.image+"?"+Math.random();document.getElementById("equip_tip").innerHTML="&nbsp;提示：<br/>&nbsp;<li>您可以将鼠标移至缩略图查看大图</li><br/>"}equipPanel.setActiveTab("equip_tab_0");editWin.items.last().getForm().loadRecord(G);if(equiptip!=null){equiptip.destroy()}if(G.data.image!=""){equiptip=new Ext.ToolTip({target:Ext.get("equip_image"),html:"<img src="+document.getElementById("equip_image").src+' width="400" height="300"></img>',title:G.data.name,width:415,frame:true,dismissDelay:0,showDelay:0,hideDelay:200})}else{equiptip=new Ext.ToolTip({target:Ext.get("equip_image"),html:'<font color="red">该设备暂时无图片！</font>',frame:true,dismissDelay:0,showDelay:0,hideDelay:200})}},errorHandler:function(C){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})}var feeWin;Ext.getDom("fee-win").innerHTML="";function showFeeWin(C,A){if(!feeWin){var B=new Ext.form.FormPanel({labelWidth:85,labelAlign:"right",frame:true,items:[new Ext.form.Hidden({name:"id"}),new Ext.form.NumberField({fieldLabel:"应收费用(元)*",name:"fee",width:200,minValue:1,maxLength:8,allowBlank:false}),new Ext.form.TextArea({fieldLabel:"备注*",name:"remark",maxLength:300,height:80,width:200,allowBlank:false})]});feeWin=new Ext.Window({el:"fee-win",title:"修改实验费用",modal:true,layout:"fit",closeAction:"hide",width:330,height:200,resizable:false,items:[B],buttons:[{text:"提交修改",handler:function(){if(B.form.isValid()){var D=B.getForm().findField("fee").getValue();var E=B.getForm().findField("remark").getValue();var F=B.getForm().findField("id").getValue();DWRUtil.useLoadingMessage("处理中...");feeWin.hide();Book.changeFee(F,D,E,{callback:function(H){cancelLoadingMessage();var G=Ext.decode(H);if(G.result){showMsg(G.message);currentStore.reload()}else{currentMsgBox=Ext.Msg.alert("报告: ",G.message)}},errorHandler:function(G){cancelLoadingMessage();Ext.Msg.alert("错误","对不起，程序出现错误!")}})}}},{text:"重置",handler:function(){B.form.reset()}},{text:"取消",handler:function(){feeWin.hide()}}]})}feeWin.show();feeWin.items.last().getForm().findField("id").setValue(C);feeWin.items.last().getForm().findField("fee").setValue(A)}var uploadWin;Ext.getDom("account-upload-win").innerHTML="";function showUploadWin(){if(!uploadWin){var A=new Ext.form.FormPanel({labelWidth:85,labelAlign:"right",frame:true,fileUpload:true,items:[{xtype:"textfield",fieldLabel:"选择Excel文件",name:"file",height:25,width:270,inputType:"file"},{html:"<font color=green>请确保您上传的是Excel2003格式的文件，且格式符合导入规则;<br/>如果不了解格式要求，请先导出为Excel修改后再导入；</font><br/><font color=red>为确保安全，Excel中密码请填写加密后的密码，123456加密后对应为e10adc3949ba59abbe56e057f20f883e</font>"}],buttons:[{text:"上传并导入",handler:function(){var C=A.getForm().findField("file").getValue();var B=C.substring(C.lastIndexOf(".")+1,C.length).toLowerCase();if(B=="xls"){uploadWin.hide();A.getForm().submit({url:"userupload",success:function(D,E){if(E.result.result){showMsg(E.result.msg);currentStore.reload()}else{Ext.Msg.alert("错误",E.result.msg)}},failure:function(){Ext.Msg.alert("错误","导入失败，请检查文件是否为Excel且格式正确且用户登录号没有冲突！")},waitMsg:"正在进行上传处理，请稍候..."})}else{A.getForm().findField("file").markInvalid("请选择要导入的文件（扩展名为xls）！")}}},{text:"取消",handler:function(){uploadWin.hide()}}]});uploadWin=new Ext.Window({el:"account-upload-win",title:"导入Excel文件到用户库",modal:true,layout:"fit",closeAction:"hide",width:410,height:175,resizable:false,items:[A]})}uploadWin.show()};