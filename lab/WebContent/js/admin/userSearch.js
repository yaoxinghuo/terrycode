function initUserSearch(B,G){Ext.getDom("search-content").innerTHML="";Ext.getDom("search-edit-win").innerHTML="";var L="";var F="no";var J=new Ext.data.DWRJsonReader({totalProperty:"results",root:"rows"},new Ext.data.Record.create([{name:"id",mapping:"id"},{name:"no",mapping:"no"},{name:"name",mapping:"name"},{name:"mobile",mapping:"mobile"},{name:"type",mapping:"type"},{name:"changed",mapping:"changed"},{name:"disabled",mapping:"disabled"},{name:"teacher",mapping:"teacher"},{name:"admin",mapping:"admin"}]));var O=new Ext.data.GroupingStore({reader:J,proxy:new Ext.data.DWRProxy({dwrFunction:Account.getAccountsBySearch,listeners:{beforeload:function(Q,R){R[Q.loadArgsKey]=[R.start,R.limit,L,F]}}}),groupField:"name",groupOnSort:true,sortInfo:{field:"admin",direction:"ASC"}});var E=new Ext.grid.CheckboxSelectionModel();var P=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),E,{header:"用户名",width:100,sortable:true,dataIndex:"no"},{header:"姓名",width:100,sortable:true,dataIndex:"name"},{header:"导师",width:100,sortable:true,dataIndex:"teacher"},{header:"联系方式",width:120,sortable:true,dataIndex:"mobile"},{header:"用户已修改密码",width:100,sortable:true,dataIndex:"changed",renderer:function(Q){if(Q){return"<font color='green'>是</font>"}else{return"<font color='red'>否</font>"}}},{header:"禁用预约",width:100,sortable:true,dataIndex:"disabled",renderer:function(Q){if(Q){return"<font color='red'>是</font>"}else{return"<font color='green'>否</font>"}}},{header:"帐户类型",width:100,sortable:true,dataIndex:"admin",renderer:function(Q){if(Q==1){return"学生"}else{if(Q==2){return"设备管理员"}else{if(Q==4){return"老师"}else{return"系统管理员"}}}}},{header:"管理设备组别",width:110,sortable:true,dataIndex:"type",renderer:function(S,R,Q){if(Q.data.admin==1||Q.data.admin==4){return"<i>不可用</i>"}else{if(S==0){return"所有设备"}else{if(equipArray[S]){return equipArray[S]}else{return"其他"}}}}}]);var I=new Ext.form.ComboBox({store:new Ext.data.SimpleStore({fields:["returnValue","displayValue"],data:[["username","用户姓名"],["no","登录用户名"],["teacher","导师"],["mobile","联系方式"]]}),valueField:"returnValue",displayField:"displayValue",allowBlank:false,typeAhead:true,editable:false,mode:"local",triggerAction:"all",value:"username",width:100,editable:false,selectOnFocus:true});var A=new Ext.grid.GridPanel({id:B,title:G,border:false,store:O,renderTo:"search-content",header:false,cm:P,sm:E,view:new Ext.grid.GroupingView({forceFit:true,sortAscText:"正序",sortDescText:"倒序",columnsText:"列显示/隐藏",groupByText:"依本列分组",showGroupsText:"分组显示",groupTextTpl:"{text} ({[values.rs.length]} 条记录)"}),collapsible:true,loadMask:true,iconCls:"user",closable:true,tbar:[{text:"批量删除",tooltip:"批量删除",iconCls:"userdel",onClick:function(){if(E.hasSelection()){var S=E.getSelections();if(S.length==1){C();return }var R=[];for(var Q=0;Q<S.length;Q++){R[Q]=S[Q].data.id}D(R)}else{showMsg("请至少选择一条记录!")}}},"-",{id:"keyword",emptyText:emptySearchText,xtype:"textfield",width:100,listeners:{specialkey:function(R,Q){if(Q.getKey()==Ext.EventObject.ENTER){L=Ext.getCmp("keyword").getEl().getValue();if(L==emptySearchText){L=""}F=I.getValue();O.reload({params:{start:0,limit:pageSize}})}}}},{text:"搜索字段:",xtype:"tbtext"},I,{text:"搜索",tooltip:"搜索",iconCls:"search",onClick:function(){L=Ext.getCmp("keyword").getEl().getValue();if(L==emptySearchText){L=""}F=I.getValue();O.reload({params:{start:0,limit:pageSize}})}},"-",{text:"Tip:请选择一条或多条用户记录操作或单击记录的右键菜单",xtype:"tbtext"}],bbar:new Ext.PagingToolbar({pageSize:pageSize,store:O,displayInfo:true})});var K=new Ext.menu.Menu({id:"searchaccountrightClickCont",items:[{id:"searchaccountEditMenu",handler:H,iconCls:"modify",text:"修改详情"},{id:"searchaccountRemoveMenu",handler:C,iconCls:"userdel",text:"删除用户"}]});A.addListener("rowcontextmenu",function(R,Q,S){S.preventDefault();R.getSelectionModel().selectRow(Q);K.showAt(S.getXY())});tabPanel.add(A).show();function D(Q){Ext.MessageBox.confirm("确认批量删除用户","是否确认批量删除用户？",function(R){if("yes"!=R){return }DWRUtil.useLoadingMessage("处理中...");Account.batchRemoveAccount(Q,{callback:function(T){cancelLoadingMessage();var S=Ext.decode(T);if(S.result){O.reload();showMsg(S.message)}else{Ext.Msg.alert("报告",S.message)}},errorHandler:function(S){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})})}function C(){var Q=A.getSelectionModel().getSelected();if(!Q){return }Ext.MessageBox.confirm("确认删除用户","是否确认删除用户？",function(R){if("yes"!=R){return }DWRUtil.useLoadingMessage("处理中...");Account.removeAccount(Q.data.id,{callback:function(T){cancelLoadingMessage();var S=Ext.decode(T);if(S.result){O.remove(Q);showMsg(S.message)}else{Ext.Msg.alert("报告",S.message)}},errorHandler:function(S){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})})}function H(){var Q=A.getSelectionModel().getSelected();if(!Q){return }M(Q.data.id)}var N;function M(R){if(!N){var Q=new Ext.FormPanel({labelWidth:80,frame:true,defaultType:"textfield",items:[new Ext.form.Hidden({name:"id"}),new Ext.form.TextField({fieldLabel:"工号/用户名*",name:"no",width:180,maxLength:50,allowBlank:false}),new Ext.form.TextField({fieldLabel:"姓名*",name:"name",width:180,maxLength:50,allowBlank:false}),new Ext.form.TextField({fieldLabel:"导师",name:"teacher",width:180,maxLength:50}),new Ext.form.TextField({fieldLabel:"联系方式",name:"mobile",width:180,maxLength:50}),new Ext.form.TextField({fieldLabel:"修改密码",inputType:"password",name:"password",width:180,maxLength:50}),new Ext.form.TextField({fieldLabel:"确认密码",name:"repassword",inputType:"password",width:180,maxLength:50}),{xtype:"checkbox",fieldLabel:"密码状态",boxLabel:"用户已修改密码",checked:true,name:"changed"},{xtype:"checkbox",fieldLabel:"预约状态",boxLabel:"禁用预约",checked:true,name:"disabled"},new Ext.form.ComboBox({fieldLabel:"账户类别*",hiddenName:"admin",store:new Ext.data.SimpleStore({fields:["returnValue","displayValue"],data:[[1,"学生"],[4,"老师"],[2,"设备管理员"],[3,"系统管理员"]]}),valueField:"returnValue",displayField:"displayValue",typeAhead:true,allowBlank:false,width:180,mode:"local",triggerAction:"all",emptyText:"选择账户类别...",selectOnFocus:true,editable:false,listeners:{select:{fn:function(U,S,T){if(T>1){Ext.getCmp("searchaccountTypeCombo").setDisabled(false)}else{Ext.getCmp("searchaccountTypeCombo").setDisabled(true)}},scope:this}}}),new Ext.form.ComboBox({fieldLabel:"所属组别*",hiddenName:"type",id:"searchaccountTypeCombo",store:new Ext.data.SimpleStore({fields:["returnValue","displayValue"],data:groupArray}),valueField:"returnValue",displayField:"displayValue",allowBlank:false,width:180,typeAhead:true,mode:"local",triggerAction:"all",emptyText:"选择组别...",selectOnFocus:true,editable:false})]});N=new Ext.Window({el:"search-edit-win",title:"修改账户记录",modal:true,layout:"fit",closeAction:"hide",width:305,height:335,resizable:false,items:[Q],buttons:[{text:"保存",handler:function(){if(Q.form.isValid()){if(Q.getForm().findField("password").getValue()!=Q.getForm().findField("repassword").getValue()){Q.getForm().findField("repassword").markInvalid("两次密码输入不一致！");return }var S=new Object();S.id=Q.getForm().findField("id").getValue();S.name=Q.getForm().findField("name").getValue();S.teacher=Q.getForm().findField("teacher").getValue();S.no=Q.getForm().findField("no").getValue();S.mobile=Q.getForm().findField("mobile").getValue();S.admin=Q.getForm().findField("admin").getValue();S.changed=Q.getForm().findField("changed").getValue();S.disabled=Q.getForm().findField("disabled").getValue();S.type=Q.getForm().findField("type").getValue();S.password=Q.getForm().findField("password").getValue();N.hide();DWRUtil.useLoadingMessage("处理中...");Account.updateAccount(Ext.encode(S),{callback:function(U){cancelLoadingMessage();var T=Ext.decode(U);if(T.result){Q.form.reset();showMsg(T.message);O.reload()}else{Ext.Msg.alert("报告",T.message)}},errorHandler:function(T){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})}}},{text:"取消",handler:function(){N.hide()}}]})}DWRUtil.useLoadingMessage("处理中...");Account.getAccountDetailInfoById(R,{callback:function(U){cancelLoadingMessage();if(!U){Ext.Msg.alert("错误","对不起，程序出现错误!");return }var S=Ext.data.Record.create([{name:"id",mapping:"id"}]);var T=new S(Ext.decode(U));N.show();N.items.last().getForm().loadRecord(T);if(Ext.decode(U).admin==1||Ext.decode(U).admin==4){Ext.getCmp("searchaccountTypeCombo").setDisabled(true)}else{Ext.getCmp("searchaccountTypeCombo").setDisabled(false)}},errorHandler:function(S){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})}};