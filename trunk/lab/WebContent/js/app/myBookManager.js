function initMyBookManager(){Ext.getDom("my-book-content").innerTHML="";var A=null;var J=null;var E=new Ext.data.DWRJsonReader({totalProperty:"results",root:"rows"},new Ext.data.Record.create([{name:"id",mapping:"id"},{name:"input",mapping:"input"},{name:"equip_id",mapping:"equip_id"},{name:"equip_name",mapping:"equip_name"},{name:"equip_no",mapping:"equip_no"},{name:"type",mapping:"type"},{name:"user_name",mapping:"user_name"},{name:"user_id",mapping:"user_id"},{name:"start",mapping:"start"},{name:"end",mapping:"end"},{name:"expired",mapping:"expired"},{name:"charge",mapping:"charge"},{name:"action",mapping:"action"},{name:"teacher",mapping:"teacher"},{name:"content",mapping:"content"},{name:"sample",mapping:"sample"},{name:"fee",mapping:"fee"},{name:"exp_time",mapping:"exp_time"},{name:"remark",mapping:"remark"},{name:"appd",mapping:"appd"},{name:"appt1",mapping:"appt1"},{name:"appt2",mapping:"appt2"}]));J=new Ext.data.Store({proxy:new Ext.data.DWRProxy({dwrFunction:Book.getBooksInfoByUserId,listeners:{beforeload:function(N,O){O[N.loadArgsKey]=[O.start,O.limit]}}}),reader:E});var K=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"填写日期",width:100,sortable:true,dataIndex:"input"},{header:"设备名称",width:100,sortable:true,dataIndex:"equip_name"},{header:"设备编号",width:100,hidden:true,sortable:true,dataIndex:"equip_no"},{header:"是否收费",width:70,sortable:true,hidden:true,dataIndex:"charge",renderer:function(N){if(N){return"<font color='red'>是</font>"}else{return"<font color='green'>否</font>"}}},{header:"类别",width:100,hidden:true,sortable:true,dataIndex:"type",renderer:function(N){if(equipArray[N]){return equipArray[N]}else{return"其他"}}},{header:"申请人",width:80,sortable:true,dataIndex:"user_name"},{header:"导师",width:80,sortable:true,dataIndex:"teacher"},{header:"样品/数量",width:120,sortable:true,dataIndex:"sample"},{header:"实验时长",width:60,sortable:true,dataIndex:"exp_time"},{header:"实验/应收费用",width:100,sortable:true,dataIndex:"fee"},{header:"审批情况",width:80,sortable:true,dataIndex:"action",renderer:function(N){if(N==0){return"<font color=blue>待批准</font>"}else{if(N==2){return"<font color=red>已删除</font>"}else{return"<font color=green>已批准</font>"}}}},{header:"起始日期",width:100,sortable:true,dataIndex:"start"},{header:"中止日期",width:100,sortable:true,dataIndex:"end"},{header:"是否过期",width:70,sortable:true,dataIndex:"expired",renderer:function(N){if(N){return"<font color='red'>是</font>"}else{return"<font color='green'>否</font>"}}},{header:"预约内容",width:150,sortable:true,dataIndex:"content"},{header:"收费备注",width:150,sortable:true,dataIndex:"remark"}]);A=new Ext.grid.GridPanel({id:"my-book",title:"我的预约记录",border:false,store:J,renderTo:"my-book-content",header:false,cm:K,loadMask:true,iconCls:"yuyue",closable:true,listeners:{rowcontextmenu:{fn:function(O,N,P){P.preventDefault();O.getSelectionModel().selectRow(N);G.showAt(P.getXY())},scope:this},rowdblclick:{fn:function(O,N,P){H()},scope:this}},tbar:[{text:"刷新",tooltip:"刷新",iconCls:"table_refresh",onClick:function(){J.reload()}},"-",{text:"以下显示我的预约情况(Tip:请双击选择编辑预约信息或按鼠标右键菜单操作)",xtype:"tbtext"}],bbar:new Ext.PagingToolbar({pageSize:pageSize,store:J,displayInfo:true})});J.load({params:{start:0,limit:pageSize}});var G=new Ext.menu.Menu({id:"mybookequiprightClickCont",items:[{id:"mybookequipEditMenu",handler:H,iconCls:"edit",text:"编辑预约信息"},{id:"mybookequipBookMenu",handler:C,iconCls:"yuyue",text:"重新预约该设备"},{id:"mybookequipDeleteMenu",handler:F,iconCls:"undo",text:"撤销预约"},{id:"mybookequipMessageMenu",handler:B,iconCls:"view",text:"查看预约内容"},{id:"mybookequipQueueMenu",handler:I,iconCls:"tabs",text:"设备预约列表"},{id:"mybookequiplistDetailMenu",handler:L,iconCls:"detail",text:"查看设备详情"}]});tabPanel.add(A).show();function L(){var N=A.getSelectionModel().getSelected();if(!N){return }showDetailWin(N.data.equip_id)}function C(){var N=A.getSelectionModel().getSelected();if(!N){return }showBookWin(N.data.equip_id,N.data.equip_name,N.data.appd,N.data.appt1,N.data.appt2)}function I(){var N=A.getSelectionModel().getSelected();if(!N){return }var O=tabPanel.getItem("queue-eq-content");if(O){tabPanel.remove(O)}O=addQueueTab(N.data.equip_id,N.data.equip_name);tabPanel.setActiveTab(O)}var D;function F(){var N=A.getSelectionModel().getSelected();if(!N){return }if(N.data.action==1){showMsg("已批准的预约记录不能撤销！");return }Ext.MessageBox.confirm("确认删除预约申请记录","是否确认删除预约申请记录？",function(O){if("yes"!=O){return }DWRUtil.useLoadingMessage("处理中...");Book.deleteBook(N.data.id,{callback:function(Q){cancelLoadingMessage();var P=Ext.decode(Q);if(P.result){J.remove(N);showMsg(P.message)}else{Ext.Msg.alert("报告",P.message)}},errorHandler:function(P){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})})}function B(){var N=A.getSelectionModel().getSelected();if(!N){return }DWRUtil.useLoadingMessage("处理中...");Book.messageBook(N.data.id,{callback:function(O){cancelLoadingMessage();Ext.MessageBox.show({title:"查看预约内容",msg:"以下显示预约内容",width:350,buttons:Ext.MessageBox.OK,multiline:true,value:O})},errorHandler:function(O){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})}function H(){var N=A.getSelectionModel().getSelected();if(!N){return }if(N.data.action!=0){showMsg("只有待批准的预约记录才能编辑！");return }M(N.data.id,N.data.equip_name,N.data.appd,N.data.appt1,N.data.appt2)}function M(P,S,N,Q,O){Ext.getDom("my-book-win").innerHTML="";bookWin=null;var R=new Ext.FormPanel({labelAlign:"right",buttonAlign:"left",frame:true,labelWidth:83,waitMsgTarget:true,items:[new Ext.form.Hidden({name:"id"}),new Ext.form.Hidden({name:"bookid"}),new Ext.form.TextField({fieldLabel:"样品名称*",name:"sample_name",width:250,maxLength:100,allowBlank:false,itemCls:"stop-float"}),new Ext.form.NumberField({fieldLabel:"样品总数*",allowDecimals:false,emptyText:"输入数字，样品数量会决定实验时间段",name:"sample_mount",width:250,minValue:1,maxLength:5,allowBlank:false,listeners:{focus:{fn:function(){R.getForm().findField("end").setValue("");R.getForm().findField("compute_fee").setValue("");R.getForm().findField("exp_time").setValue("")},scope:this}},itemCls:"stop-float"}),{xtype:"xdatetime",name:"start",fieldLabel:"预约起始时间*",anchor:"-35",timeWidth:105,timeFormat:"H:i",listeners:{focus:{fn:function(){R.getForm().findField("end").setValue("");R.getForm().findField("compute_fee").setValue("");R.getForm().findField("exp_time").setValue("")},scope:this}},timeConfig:{allowBlank:false,minValue:Q,maxValue:O,increment:30},dateFormat:"Y-m-d",dateConfig:{minValue:new Date().format("Y-m-d"),disabledDays:N,allowBlank:false}},new Ext.form.TextField({fieldLabel:"预约结束时间",name:"end",emptyText:"结束时间由系统自动计算出,按“计算”",readOnly:true,width:250}),new Ext.form.TextField({fieldLabel:"实验时长",name:"exp_time",emptyText:"如果太短，请适当修改样品数量",readOnly:true,width:250}),new Ext.form.TextField({fieldLabel:"预期实验费用",name:"compute_fee",emptyText:"实验费用由系统自动计算出,供参考",readOnly:true,width:250,maxLength:10}),new Ext.form.TextArea({fieldLabel:"预约内容",name:"content",maxLength:300,height:100,width:250})]});D=new Ext.Window({el:"my-book-win",modal:true,layout:"fit",closeAction:"hide",width:400,height:330,items:[R],buttons:[{text:"计算",tooltip:"根据样品数计算预约结束日期和预期费用",handler:function(){R.getForm().findField("start").updateValue();if(R.form.isValid()){var U=R.getForm().findField("start").getValue();var T=R.getForm().findField("sample_mount").getValue();var V=R.getForm().findField("id").getValue();DWRUtil.useLoadingMessage("处理中...");Book.computerEndDateAndFee(V,U.format("Y-m-d H:i"),T,{callback:function(X){cancelLoadingMessage();var W=Ext.decode(X);if(W.result){R.getForm().findField("end").setValue(W.endDate);R.getForm().findField("compute_fee").setValue(W.compute_fee);R.getForm().findField("exp_time").setValue(W.exp_time);if(W.invalid==true){R.getForm().findField("end").markInvalid(W.invalidmsg)}}else{currentMsgBox=Ext.Msg.alert("预约报告: ",W.message)}},errorHandler:function(W){cancelLoadingMessage();Ext.Msg.alert("错误","对不起，程序出现错误!")}})}}},{text:"更新预约",handler:function(){R.getForm().findField("start").updateValue();if(R.form.isValid()){var V=R.getForm().findField("start").getValue();var Z=R.getForm().findField("end").getValue();var U=R.getForm().findField("sample_mount").getValue();var T=R.getForm().findField("sample_name").getValue();var Y=R.getForm().findField("compute_fee").getValue();var X=R.getForm().findField("content").getValue();var W=R.getForm().findField("bookid").getValue();if(Z==""||Y==""){Ext.Msg.alert("预约报告","请先按“计算”确定预约结束日期和费用!")}else{D.hide();DWRUtil.useLoadingMessage("处理中...");Book.updateBook(W,V.format("Y-m-d H:i"),Z,T,U,Y,X,{callback:function(b){cancelLoadingMessage();var a=Ext.decode(b);if(a.result){J.reload();showMsg(a.message)}else{currentMsgBox=Ext.Msg.alert("预约报告: ",a.message)}},errorHandler:function(a){cancelLoadingMessage();Ext.Msg.alert("错误","对不起，程序出现错误!")}})}}}},{text:"重置",handler:function(){R.form.reset()}},{text:"取消",handler:function(){D.hide()}}]});DWRUtil.useLoadingMessage("处理中...");Book.getBookDetailById(P,{callback:function(V){cancelLoadingMessage();if(!V){Ext.Msg.alert("错误","对不起，程序出现错误!");return }var T=Ext.data.Record.create([{name:"id",mapping:"id"}]);var U=new T(Ext.decode(V));D.show();D.setTitle("设备预约: "+S);D.items.last().getForm().loadRecord(U)},errorHandler:function(T){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})}};