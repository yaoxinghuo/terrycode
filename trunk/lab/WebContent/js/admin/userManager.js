function initUserManager(B,F){Ext.getDom("user-content").innerTHML="";Ext.getDom("user-account-edit-win").innerHTML="";Ext.getDom("user-account-add-win").innerHTML="";var H=new Ext.data.DWRJsonReader({totalProperty:"results",root:"rows"},new Ext.data.Record.create([{name:"id",mapping:"id"},{name:"no",mapping:"no"},{name:"name",mapping:"name"},{name:"mobile",mapping:"mobile"},{name:"teacher",mapping:"teacher"},{name:"changed",mapping:"changed"},{name:"disabled",mapping:"disabled"},{name:"admin",mapping:"admin"}]));var N=new Ext.data.GroupingStore({reader:H,proxy:new Ext.data.DWRProxy({dwrFunction:Account.getAccounts,listeners:{beforeload:function(P,Q){Q[P.loadArgsKey]=[Q.start,Q.limit,1]}}}),groupField:"name",groupOnSort:true,sortInfo:{field:"admin",direction:"ASC"}});var E=new Ext.grid.CheckboxSelectionModel();var O=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),E,{header:"学号/用户名",width:100,sortable:true,dataIndex:"no"},{header:"姓名",width:100,sortable:true,dataIndex:"name"},{header:"导师",width:100,sortable:true,dataIndex:"teacher"},{header:"联系方式",width:100,sortable:true,dataIndex:"mobile"},{header:"用户已修改密码",width:100,sortable:true,dataIndex:"changed",renderer:function(P){if(P){return"<font color='green'>是</font>"}else{return"<font color='red'>否</font>"}}},{header:"禁用预约",width:100,sortable:true,dataIndex:"disabled",renderer:function(P){if(P){return"<font color='red'>是</font>"}else{return"<font color='green'>否</font>"}}},{header:"帐户类型",width:100,sortable:true,dataIndex:"admin",renderer:function(P){if(P==1){return"学生"}else{if(P==2){return"设备管理员"}else{if(P==4){return"老师"}else{return"系统管理员"}}}}}]);var A=new Ext.grid.GridPanel({id:B,title:F,border:false,store:N,renderTo:"user-content",header:false,cm:O,sm:E,view:new Ext.grid.GroupingView({forceFit:true,sortAscText:"正序",sortDescText:"倒序",columnsText:"列显示/隐藏",groupByText:"依本列分组",showGroupsText:"分组显示",groupTextTpl:"{text} ({[values.rs.length]} 条记录)"}),collapsible:true,loadMask:true,iconCls:"user",closable:true,tbar:[{text:"新增用户",tooltip:"新增用户记录",iconCls:"useradd",onClick:function(){L()}},"-",{text:"批量删除",tooltip:"批量删除",iconCls:"userdel",onClick:function(){if(E.hasSelection()){var R=E.getSelections();if(R.length==1){C();return }var Q=[];for(var P=0;P<R.length;P++){Q[P]=R[P].data.id}D(Q)}else{showMsg("请至少选择一条记录!")}}},"-",{text:"刷新",tooltip:"刷新",iconCls:"refresh",onClick:function(){N.reload()}},"-",{text:"导出为Excel",tooltip:"导出为Excel并下载到本地",iconCls:"excel",onClick:function(){window.location.href="userdownload?type=1"}},{text:"导入Excel",tooltip:"把本地Excel文件导入到用户库",iconCls:"excel",onClick:function(){currentStore=N;showUploadWin()}},"-",{text:"Tip:请选择一条或多条用户记录操作或单击记录的右键菜单",xtype:"tbtext"}],bbar:new Ext.PagingToolbar({pageSize:pageSize,store:N,displayInfo:true})});N.load({params:{start:0,limit:pageSize}});var I=new Ext.menu.Menu({id:"useraccountrightClickCont",items:[{id:"useraccountEditMenu",handler:G,iconCls:"modify",text:"修改详情"},{id:"useraccountRemoveMenu",handler:C,iconCls:"userdel",text:"删除用户"}]});A.addListener("rowcontextmenu",function(Q,P,R){R.preventDefault();Q.getSelectionModel().selectRow(P);I.showAt(R.getXY())});tabPanel.add(A).show();function D(P){Ext.MessageBox.confirm("确认批量删除用户","是否确认批量删除用户？",function(Q){if("yes"!=Q){return }DWRUtil.useLoadingMessage("处理中...");Account.batchRemoveAccount(P,{callback:function(S){cancelLoadingMessage();var R=Ext.decode(S);if(R.result){N.reload();showMsg(R.message)}else{Ext.Msg.alert("报告",R.message)}},errorHandler:function(R){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})})}function C(){var P=A.getSelectionModel().getSelected();if(!P){return }Ext.MessageBox.confirm("确认删除用户","是否确认删除用户？",function(Q){if("yes"!=Q){return }DWRUtil.useLoadingMessage("处理中...");Account.removeAccount(P.data.id,{callback:function(S){cancelLoadingMessage();var R=Ext.decode(S);if(R.result){N.remove(P);showMsg(R.message)}else{Ext.Msg.alert("报告",R.message)}},errorHandler:function(R){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})})}function G(){var P=A.getSelectionModel().getSelected();if(!P){return }K(P.data.id)}var J;var M;function L(){if(!J){var P=new Ext.FormPanel({labelWidth:80,frame:true,defaultType:"textfield",items:[new Ext.form.TextField({fieldLabel:"学号/用户名*",emptyText:"确保该用户名不与其他用户重复",name:"no",width:180,maxLength:50,allowBlank:false}),new Ext.form.TextField({fieldLabel:"姓名*",emptyText:"请填写用户真实姓名",name:"name",width:180,maxLength:50,allowBlank:false}),new Ext.form.TextField({fieldLabel:"导师",emptyText:"请填写导师姓名（可选）",name:"teacher",width:180,maxLength:50}),new Ext.form.TextField({fieldLabel:"联系方式",emptyText:"请填写手机或Email等",name:"mobile",width:180,maxLength:50}),new Ext.form.TextField({fieldLabel:"初始密码*",inputType:"password",name:"password",id:"user_password",allowBlank:false,width:180,maxLength:50}),new Ext.form.TextField({fieldLabel:"确认密码*",name:"repassword",inputType:"password",vtype:"password",initialPassField:"user_password",allowBlank:false,width:180,maxLength:50}),new Ext.form.ComboBox({fieldLabel:"账户类别*",hiddenName:"admin",store:new Ext.data.SimpleStore({fields:["returnValue","displayValue"],data:[[1,"学生"],[4,"老师"]]}),valueField:"returnValue",displayField:"displayValue",allowBlank:false,width:180,typeAhead:true,mode:"local",triggerAction:"all",emptyText:"选择账户类别...",selectOnFocus:true,editable:false})]});J=new Ext.Window({el:"user-account-add-win",title:"增加用户记录",modal:true,layout:"fit",closeAction:"hide",width:325,height:270,resizable:false,items:[P],buttons:[{text:"保存",handler:function(){if(P.form.isValid()){var Q=new Object();var R=new Object();R.name=P.getForm().findField("name").getValue();R.no=P.getForm().findField("no").getValue();R.teacher=P.getForm().findField("teacher").getValue();R.mobile=P.getForm().findField("mobile").getValue();R.admin=P.getForm().findField("admin").getValue();R.type=1;R.password=P.getForm().findField("password").getValue();J.hide();DWRUtil.useLoadingMessage("处理中...");Account.saveAccount(Ext.encode(R),{callback:function(T){cancelLoadingMessage();var S=Ext.decode(T);if(S.result){P.form.reset();showMsg(S.message);N.reload()}else{Ext.Msg.alert("报告",S.message)}},errorHandler:function(S){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})}}},{text:"重置",handler:function(){P.form.reset()}},{text:"取消",handler:function(){J.hide()}}]})}J.show()}function K(Q){if(!M){var P=new Ext.FormPanel({labelWidth:80,frame:true,defaultType:"textfield",items:[new Ext.form.Hidden({name:"id"}),new Ext.form.TextField({fieldLabel:"学号/用户名*",name:"no",width:180,maxLength:50,allowBlank:false}),new Ext.form.TextField({fieldLabel:"姓名*",name:"name",width:180,maxLength:50,allowBlank:false}),new Ext.form.TextField({fieldLabel:"导师",name:"teacher",width:180,maxLength:50}),new Ext.form.TextField({fieldLabel:"联系方式",name:"mobile",width:180,maxLength:50}),new Ext.form.TextField({fieldLabel:"修改密码",inputType:"password",name:"password",width:180,maxLength:50}),new Ext.form.TextField({fieldLabel:"确认密码",name:"repassword",inputType:"password",width:180,maxLength:50}),{xtype:"checkbox",fieldLabel:"密码状态",boxLabel:"用户已修改密码",checked:true,name:"changed"},{xtype:"checkbox",fieldLabel:"预约状态",boxLabel:"禁用预约",checked:false,name:"disabled"},new Ext.form.ComboBox({fieldLabel:"账户类别*",hiddenName:"admin",store:new Ext.data.SimpleStore({fields:["returnValue","displayValue"],data:[[1,"学生"],[4,"老师"],[2,"设备管理员"],[3,"系统管理员"]]}),valueField:"returnValue",displayField:"displayValue",typeAhead:true,allowBlank:false,width:180,mode:"local",triggerAction:"all",emptyText:"选择账户类别...",selectOnFocus:true,editable:false,listeners:{select:{fn:function(T,R,S){if(S>1){Ext.getCmp("useraccountTypeCombo").setDisabled(false)}else{Ext.getCmp("useraccountTypeCombo").setDisabled(true)}},scope:this}}}),new Ext.form.ComboBox({fieldLabel:"所属组别*",hiddenName:"type",id:"useraccountTypeCombo",store:new Ext.data.SimpleStore({fields:["returnValue","displayValue"],data:groupArray}),valueField:"returnValue",displayField:"displayValue",allowBlank:false,width:180,typeAhead:true,mode:"local",triggerAction:"all",emptyText:"选择组别...",selectOnFocus:true,editable:false})]});M=new Ext.Window({el:"user-account-edit-win",title:"修改账户记录",modal:true,layout:"fit",closeAction:"hide",width:325,height:340,resizable:false,items:[P],buttons:[{text:"保存",handler:function(){if(P.form.isValid()){if(P.getForm().findField("password").getValue()!=P.getForm().findField("repassword").getValue()){P.getForm().findField("repassword").markInvalid("两次密码输入不一致！");return }var R=new Object();R.id=P.getForm().findField("id").getValue();R.name=P.getForm().findField("name").getValue();R.teacher=P.getForm().findField("teacher").getValue();R.no=P.getForm().findField("no").getValue();R.mobile=P.getForm().findField("mobile").getValue();R.admin=P.getForm().findField("admin").getValue();R.changed=P.getForm().findField("changed").getValue();R.disabled=P.getForm().findField("disabled").getValue();R.type=P.getForm().findField("type").getValue();R.password=P.getForm().findField("password").getValue();M.hide();DWRUtil.useLoadingMessage("处理中...");Account.updateAccount(Ext.encode(R),{callback:function(T){cancelLoadingMessage();var S=Ext.decode(T);if(S.result){P.form.reset();showMsg(S.message);if(R.admin!=1&&R.admin!=4){Ext.MessageBox.alert("更改用户类别","您已经选择提升该用户权限，该用户将显示在‘管理员信息’里。")}N.reload()}else{Ext.Msg.alert("报告",S.message)}},errorHandler:function(S){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})}}},{text:"取消",handler:function(){M.hide()}}]})}DWRUtil.useLoadingMessage("处理中...");Account.getAccountDetailInfoById(Q,{callback:function(T){cancelLoadingMessage();if(!T){Ext.Msg.alert("错误","对不起，程序出现错误!");return }var R=Ext.data.Record.create([{name:"id",mapping:"id"},{name:"no",mapping:"no"},{name:"name",mapping:"name"},{name:"mobile",mapping:"mobile"},{name:"admin",mapping:"admin"},{name:"password",mapping:"password"},{name:"repassword",mapping:"repassword"},{name:"changed",mapping:"changed"},{name:"disabled",mapping:"disabled"}]);var S=new R(Ext.decode(T));M.show();M.items.last().getForm().loadRecord(S);Ext.getCmp("useraccountTypeCombo").setDisabled(true)},errorHandler:function(R){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})}};