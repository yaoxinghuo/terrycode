var noticeContent="";var editorInstance0;var editorInstance1;var currentInstance=0;function initNoticeManager(L,Q){Ext.getDom("notice-content").innerTHML="";Ext.getDom("notice-add-win").innerHTML="";Ext.getDom("notice-edit-win").innerHTML="";var A=null;var I=null;var D=false;var C=new Ext.data.DWRJsonReader({totalProperty:"results",root:"rows"},new Ext.data.Record.create([{name:"id",mapping:"id"},{name:"input",mapping:"input"},{name:"title",mapping:"title"},{name:"type",mapping:"type"},{name:"date",mapping:"date"},{name:"pub",mapping:"pub"}]));I=new Ext.data.GroupingStore({proxy:new Ext.data.DWRProxy({dwrFunction:Notice.getNotices,listeners:{beforeload:function(S,T){T[S.loadArgsKey]=[T.start,T.limit,D]}}}),reader:C,groupField:"title",groupOnSort:true,sortInfo:{field:"type",direction:"ASC"}});var P=new Ext.grid.CheckboxSelectionModel();var J=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),P,{header:"填写日期",width:100,sortable:true,dataIndex:"input"},{header:"公告类型",width:100,sortable:true,dataIndex:"type",renderer:function(S){if(S==1){return"通知公告"}else{if(S==2){return"设备使用公告"}else{if(S==3){return"管理制度"}else{return"实验室概况"}}}}},{header:"公告标题",width:300,sortable:true,dataIndex:"title"},{header:"显示日期",width:100,sortable:true,dataIndex:"date"},{header:"前台显示",width:70,sortable:true,dataIndex:"pub",renderer:function(S){if(S){return"<font color='red'>是</font>"}else{return"<font color='green'>否</font>"}}}]);A=new Ext.grid.GridPanel({id:L,title:Q,border:false,store:I,renderTo:"notice-content",header:false,cm:J,sm:P,view:new Ext.grid.GroupingView({forceFit:true,sortAscText:"正序",sortDescText:"倒序",columnsText:"列显示/隐藏",groupByText:"依本列分组",showGroupsText:"分组显示",groupTextTpl:"{text} ({[values.rs.length]} 条记录)"}),loadMask:true,iconCls:"notice",closable:true,tbar:[{text:"新建公告",tooltip:"新建公告",iconCls:"add",onClick:function(){noticeContent="";N()}},"-",{text:"批量删除",tooltip:"批量删除",iconCls:"remove",onClick:function(){if(P.hasSelection()){var U=P.getSelections();if(U.length==1){O();return }var T=[];for(var S=0;S<U.length;S++){T[S]=U[S].data.id}E(T)}else{showMsg("请至少选择一条记录!")}}},"-",{text:"刷新",tooltip:"刷新",iconCls:"refresh",onClick:function(){I.reload()}},"-",{xtype:"checkbox",boxLabel:"<b>前台显示的记录</b>",checked:false,listeners:{check:{fn:function(T,S){if(D!=S){D=S;I.reload({params:{start:0,limit:pageSize}})}},scope:this}}},"-",{text:"Tip:请选择一条或多条公告记录操作或单击记录的右键菜单",xtype:"tbtext"}],bbar:new Ext.PagingToolbar({pageSize:pageSize,store:I,displayInfo:true})});I.load({params:{start:0,limit:pageSize}});var B=new Ext.menu.Menu({id:"noticerightClickCont",items:[{id:"noticeEditMenu",handler:F,iconCls:"view",text:"查看/编辑公告"},{id:"noticeRemoveMenu",handler:O,iconCls:"remove",text:"删除"}]});A.addListener("rowcontextmenu",function(T,S,U){U.preventDefault();T.getSelectionModel().selectRow(S);B.showAt(U.getXY())});tabPanel.add(A).show();function F(){var S=A.getSelectionModel().getSelected();if(!S){return }G(S.data.id)}function E(S){Ext.MessageBox.confirm("确认批量删除公告","是否确认批量删除公告？",function(T){if("yes"!=T){return }DWRUtil.useLoadingMessage("处理中...");Notice.batchRemoveNotice(S,{callback:function(V){cancelLoadingMessage();var U=Ext.decode(V);if(U.result){I.reload();showMsg(U.message)}else{Ext.Msg.alert("报告",U.message)}},errorHandler:function(U){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})})}function O(){var S=A.getSelectionModel().getSelected();if(!S){return }Ext.MessageBox.confirm("确认删除公告","是否确认删除公告？",function(T){if("yes"!=T){return }DWRUtil.useLoadingMessage("处理中...");Notice.removeNotice(S.data.id,{callback:function(V){cancelLoadingMessage();var U=Ext.decode(V);if(U.result){I.remove(S);showMsg(U.message)}else{Ext.Msg.alert("报告",U.message)}},errorHandler:function(U){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})})}var R=null;var H=null;var K;var M;function N(){currentInstance=0;if(!R){var S=new Ext.FormPanel({labelWidth:75,labelAlign:"right",frame:true,items:[{xtype:"checkbox",fieldLabel:"标题样式",boxLabel:"粗体",itemCls:"notice-left0",clearCls:"allow-float",name:"bold"},{xtype:"checkbox",fieldLabel:"",hideLabel:true,boxLabel:"红色",itemCls:"notice-left",clearCls:"allow-float",name:"red"},new Ext.form.TextField({fieldLabel:"公告标题*",name:"title",width:350,maxLength:50,itemCls:"notice-left",clearCls:"stop-float",allowBlank:false}),new Ext.form.ComboBox({fieldLabel:"公告类别*",hiddenName:"type",store:new Ext.data.SimpleStore({fields:["returnValue","displayValue"],data:[[1,"通知公告"],[2,"设备使用公告"],[3,"管理制度"],[4,"实验室概况"]]}),valueField:"returnValue",displayField:"displayValue",typeAhead:true,allowBlank:false,itemCls:"comp-left0",clearCls:"allow-float",width:180,mode:"local",triggerAction:"all",emptyText:"选择公告类别...",selectOnFocus:true,editable:false}),{xtype:"datefield",fieldLabel:"显示日期*",name:"date",width:100,format:"Y-m-d",itemCls:"notice-left",clearCls:"allow-float",allowBlank:false},{xtype:"checkbox",fieldLabel:"显示状态",boxLabel:"前台显示",itemCls:"notice-left",clearCls:"stop-float",name:"pub"},{xtype:"textarea",fieldLabel:"公告正文*",id:"content",name:"content",itemCls:"notice-left0",height:200,width:300}]});R=new Ext.Window({el:"notice-add-win",title:"新增公告",modal:true,layout:"fit",closeAction:"hide",width:800,height:500,resizable:false,items:[S],buttons:[{text:"保存",handler:function(){Ext.get("content").dom.value=editorInstance0.GetXHTML(true);if(S.form.isValid()){var T=new Object();T.title=S.getForm().findField("title").getValue();T.bold=S.getForm().findField("bold").getValue();T.red=S.getForm().findField("red").getValue();T.content=S.getForm().findField("content").getValue();T.type=S.getForm().findField("type").getValue();T.pub=S.getForm().findField("pub").getValue();T.date=S.getForm().findField("date").getValue();R.hide();DWRUtil.useLoadingMessage("处理中...");Notice.saveNotice(Ext.encode(T),{callback:function(V){cancelLoadingMessage();var U=Ext.decode(V);if(U.result){editorInstance0.SetHTML("");showMsg(U.message);I.reload();S.form.reset()}else{Ext.Msg.alert("报告",U.message)}},errorHandler:function(U){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})}}},{text:"取消",handler:function(){R.hide()}}]})}R.show();if(!K){K=new FCKeditor("content",680,350);K.BasePath="/lab/fckeditor/";K.ToolbarSet="Basic";K.ReplaceTextarea()}}function G(T){currentInstance=1;if(!H){var S=new Ext.FormPanel({labelWidth:75,labelAlign:"right",frame:true,items:[new Ext.form.Hidden({name:"id"}),{xtype:"checkbox",fieldLabel:"标题样式",boxLabel:"粗体",itemCls:"notice-left0",clearCls:"allow-float",name:"bold"},{xtype:"checkbox",fieldLabel:"",hideLabel:true,boxLabel:"红色",itemCls:"notice-left",clearCls:"allow-float",name:"red"},new Ext.form.TextField({fieldLabel:"公告标题*",name:"title",width:350,maxLength:50,itemCls:"notice-left0",clearCls:"stop-float",allowBlank:false}),new Ext.form.ComboBox({fieldLabel:"公告类别*",hiddenName:"type",store:new Ext.data.SimpleStore({fields:["returnValue","displayValue"],data:[[1,"通知公告"],[2,"设备使用公告"],[3,"管理制度"],[4,"实验室概况"]]}),valueField:"returnValue",displayField:"displayValue",typeAhead:true,allowBlank:false,itemCls:"notice-left0",clearCls:"allow-float",width:180,mode:"local",triggerAction:"all",emptyText:"选择公告类别...",selectOnFocus:true,editable:false}),{xtype:"datefield",fieldLabel:"显示日期*",name:"date",width:100,format:"Y-m-d",itemCls:"notice-left",clearCls:"allow-float",allowBlank:false},{xtype:"checkbox",fieldLabel:"显示状态",boxLabel:"前台显示",itemCls:"notice-left",clearCls:"stop-float",name:"pub"},{xtype:"textarea",fieldLabel:"公告正文*",id:"e_content",name:"e_content",itemCls:"notice-left0",height:200,width:300}]});H=new Ext.Window({el:"notice-edit-win",title:"编辑公告",modal:true,layout:"fit",closeAction:"hide",width:800,height:500,resizable:false,items:[S],buttons:[{text:"保存",handler:function(){Ext.get("e_content").dom.value=editorInstance1.GetXHTML(true);if(S.form.isValid()){var U=new Object();U.id=S.getForm().findField("id").getValue();U.bold=S.getForm().findField("bold").getValue();U.red=S.getForm().findField("red").getValue();U.title=S.getForm().findField("title").getValue();U.content=S.getForm().findField("e_content").getValue();U.type=S.getForm().findField("type").getValue();U.pub=S.getForm().findField("pub").getValue();U.date=S.getForm().findField("date").getValue();H.hide();DWRUtil.useLoadingMessage("处理中...");Notice.updateNotice(Ext.encode(U),{callback:function(W){cancelLoadingMessage();var V=Ext.decode(W);if(V.result){showMsg(V.message);I.reload();S.form.reset()}else{Ext.Msg.alert("报告",V.message)}},errorHandler:function(V){Ext.Msg.alert("错误","对不起，程序出现错误!");cancelLoadingMessage()}})}}},{text:"取消",handler:function(){H.hide()}}]})}DWRUtil.useLoadingMessage("处理中...");Notice.getNoticeById(T,{callback:function(W){cancelLoadingMessage();if(!W){Ext.Msg.alert("错误","对不起，程序出现错误!");return }var U=Ext.data.Record.create([{name:"id",mapping:"id"},{name:"title",mapping:"title"},{name:"bold",mapping:"bold"},{name:"red",mapping:"red"},{name:"date",mapping:"date"},{name:"type",mapping:"type"},{name:"content",mapping:"e_content"},{name:"pub",mapping:"pub"},]);var V=new U(Ext.decode(W));noticeContent=Ext.decode(W).content;H.show();H.items.last().getForm().loadRecord(V);if(!M){M=new FCKeditor("e_content",680,350);M.BasePath="/lab/fckeditor/";M.ToolbarSet="Basic";M.ReplaceTextarea()}if(editorInstance1){editorInstance1.SetHTML(noticeContent)}},errorHandler:function(U){cancelLoadingMessage()}})}}function FCKeditor_OnComplete(A){if(currentInstance==0){editorInstance0=A}else{editorInstance1=A;editorInstance1.SetHTML(noticeContent)}};